// ai/chatAI.js

const { GoogleGenerativeAI } = require('@google/generative-ai');
const Event = require("../models/Event");

const apiKey = process.env.GEMINI_API_KEY;
const genAI = new GoogleGenerativeAI(apiKey);
const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

async function generateRecommendationsDirect(prompt) {
    try {
        const events = await Event.find();
        const currentDate = new Date();
        const upcomingEvents = events.filter(event =>
            event.eventDate && new Date(event.eventDate) >= currentDate
        );


        const fullPrompt = `
–¢—ã ‚Äî —É–º–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π Telegram-–±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ SDU üéì.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ, –∏ –ø–æ–¥–±–∞–¥—Ä–∏–≤–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –æ–Ω–∏ –∑–≤—É—á–∞—Ç —Ä–∞—Å—Ç–µ—Ä—è–Ω–Ω–æ, –≥—Ä—É—Å—Ç–Ω–æ –∏–ª–∏ –∑–∞–º–∫–Ω—É—Ç–æ.

–†–∞–±–æ—Ç–∞–π —Å—Ç—Ä–æ–≥–æ –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∞–≤–∏–ª–∞–º:

---

üìå **1. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø–æ —Ç–µ–º–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π**  
(–ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–æ –æ—Ü–µ–Ω–∫–∏, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –¥–æ–º–∞—à–∫—É, –ø–æ–≥–æ–¥—É –∏ —Ç.–ø.)  
‚û°Ô∏è –û—Ç–≤–µ—Ç—å –≤–µ–∂–ª–∏–≤–æ, –Ω–æ —á—ë—Ç–∫–æ:  
**"–Ø –ø–æ–∫–∞ —É–º–µ—é —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –≤ SDU üåü –ï—Å–ª–∏ —Ö–æ—á–µ—à—å —á—Ç–æ-—Ç–æ –ø–æ—Å–µ—Ç–∏—Ç—å –∏–ª–∏ —Å—Ç–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–µ–µ ‚Äî —è —Å —Ä–∞–¥–æ—Å—Ç—å—é –ø–æ–º–æ–≥—É!"**  
*–ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–æ–±—ã—Ç–∏—è.*

---

üìå **2. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ**  
(–ù–∞–ø—Ä–∏–º–µ—Ä: "–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç TEDx?", "–ß—Ç–æ —Ç–∞–∫–æ–µ SDU Fest?, –∫–∞–∫–∏–µ –∫–ª—É–±—ã –µ—Å—Ç—å?")  
‚û°Ô∏è –ù–∞–π–¥–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (—É—á–∏—Ç—ã–≤–∞–π —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–π —Ä–µ–≥–∏—Å—Ç—Ä).  
–û—Ç–≤–µ—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ:  
**–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ *{–Ω–∞–∑–≤–∞–Ω–∏–µ}* –ø—Ä–æ–π–¥—ë—Ç {–¥–∞—Ç–∞}. {–û–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ "–ü–æ–∫–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã."}**  
–î–æ–±–∞–≤—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ, —Ç–∏–ø–∞:  
**"–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–≥–ª—è–Ω–∏ ‚Äî –±—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ!"**

---

üìå **3. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —Ç–µ–º–µ –≤ –æ–±—â–µ–º**  
(–ù–∞–ø—Ä–∏–º–µ—Ä: "–ß—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ –≤ SDU?", "–ï—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ –¥–ª—è –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤?", "–Ø —Ö–æ—á—É –∑–∞–≤–µ—Å—Ç–∏ –¥—Ä—É–∑–µ–π", "–ì—Ä—É—Å—Ç–Ω–æ –∫–∞–∫-—Ç–æ...")  
‚û°Ô∏è –í—ã–±–µ—Ä–∏ **2‚Äì4 –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è** –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ.  
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–ø–∏—à–∏ –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –ø–æ—á–µ–º—É –æ–Ω–æ –º–æ–∂–µ—Ç –ø–æ–¥–æ–π—Ç–∏.  
–°—Ç–∞—Ä–∞–π—Å—è –æ—Ç–≤–µ—á–∞—Ç—å —Ç—ë–ø–ª–æ, –≤–æ–æ–¥—É—à–µ–≤–ª—è—é—â–µ –∏ —Å –ª—ë–≥–∫–∏–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º —Ç–æ–Ω–æ–º. –ù–∞–ø—Ä–∏–º–µ—Ä:  
> *"–≠—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –º–æ–∂–µ—Ç –ø–æ–¥–∞—Ä–∏—Ç—å —Ç–µ–±–µ –Ω–æ–≤—ã—Ö –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä—è–¥ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è ‚òÄÔ∏è"*

–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–≤—É—á–∏—Ç —É–Ω—ã–ª–æ, –∑–∞–º–∫–Ω—É—Ç–æ –∏–ª–∏ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ ‚Äî –¥–æ–±–∞–≤—å –≤ –∫–æ–Ω—Ü–µ 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:  
> **"–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, –≤ SDU —Ç—ã –Ω–µ –æ–¥–∏–Ω ‚Äî —Ç—É—Ç –≤—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ —á—Ç–æ-—Ç–æ –ø–æ –¥—É—à–µ –∏ —Ö–æ—Ä–æ—à–∏—Ö –ª—é–¥–µ–π —Ä—è–¥–æ–º üíô"**

---

üìù **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª:**  
"${prompt}"

---

üìÖ **–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π:**
${upcomingEvents.map((e, i) => `
*${i + 1}. ${e.title}*  
üìç –õ–æ–∫–∞—Ü–∏—è: ${e.location || "–ù–µ —É–∫–∞–∑–∞–Ω–∞"}  
üìÜ –î–∞—Ç–∞: ${new Date(e.eventDate).toLocaleDateString()}  
üìù –û–ø–∏—Å–∞–Ω–∏–µ: ${e.description || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}`).join("\n\n")}
`;




        const result = await model.generateContent({
            contents: [
                {
                    role: "user",
                    parts: [{ text: fullPrompt }]
                }
            ]
        });


        const text = result.response.text();
        // –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ JSON-–º–∞—Å—Å–∏–≤ –≤ —Ç–µ–∫—Å—Ç–µ
        const match = text.match(/\[.*\]/s);
        let ids = [];
        if (match) {
            try {
                const jsonCandidate = match[0].trim();
                if (jsonCandidate.startsWith("[") && jsonCandidate.endsWith("]")) {
                    ids = JSON.parse(jsonCandidate);
                }
            } catch (e) {
                console.warn("‚ö†Ô∏è JSON-–ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —É–¥–∞–ª—Å—è:", e);
            }
        }



// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏ —Ç–µ–∫—Å—Ç, –∏ ID, –¥–∞–∂–µ –µ—Å–ª–∏ –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç–æ–π
        return {
            response: text.split(match?.[0])[0].trim(), // –¢–µ–∫—Å—Ç –±–µ–∑ JSON
            recommendedEvents: ids
        };

    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:", error);
        return {
            response: "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.",
            recommendedEvents: []
        };
    }
}

module.exports = { generateRecommendationsDirect };
